<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Average Balance Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
    .card {
      background:#fff; padding:20px; max-width:720px;
      border-radius:12px; box-shadow: 0 2px 12px rgba(0,0,0,.06);
    }
    h2 { margin:0 0 10px 0; }
    .muted { color:#6b7280; font-size:13px; margin-bottom:16px; }
    label { display:block; margin-top:12px; font-weight:600; }
    .help { font-weight:700; margin-left:6px; cursor:help; color:#374151; }
    input, select {
      width:100%; padding:10px; margin-top:6px;
      border:1px solid #d6dbe1; border-radius:10px;
    }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    button {
      margin-top:16px; width:100%; padding:12px;
      border:0; border-radius:10px;
      background:#0078d4; color:#fff;
      font-weight:700; cursor:pointer;
    }
    button.secondary { background:#374151; margin-top:10px; }
    .out {
      margin-top:16px; padding:14px;
      background:#f8fafc; border:1px solid #e5e7eb;
      border-radius:12px;
    }
    .kv { display:flex; justify-content:space-between; gap:12px; }
    .k { font-weight:700; }
    .v { font-variant-numeric: tabular-nums; }
    #error { margin-top:12px; color:#b91c1c; font-weight:700; }
  </style>
</head>

<body>
<div class="card">
  <h2>Average Balance Calculator</h2>
  <p class="muted">Clean version matching Excel logic. Days Required is calculated internally.</p>

  <div class="row">
    <div>
      <label>Opening Balance (£)<span class="help" title="Balance at the start of the month.">ⓘ</span></label>
      <input id="opening" type="number" step="0.01" value="0">
    </div>
    <div>
      <label>Closing Balance (£)<span class="help" title="Balance held after the cut off date.">ⓘ</span></label>
      <input id="closing" type="number" step="0.01" value="400000">
    </div>
  </div>

  <div class="row">
    <div>
      <label>Month<span class="help" title="Used to determine days in month (hidden).">ⓘ</span></label>
      <select id="month">
        <option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option>
        <option>May</option><option>Jun</option><option>Jul</option><option>Aug</option>
        <option>Sep</option><option>Oct</option><option>Nov</option><option>Dec</option>
      </select>
    </div>
    <div>
      <label>Year<span class="help" title="Used for cut off date display.">ⓘ</span></label>
      <input id="year" type="number" value="2026">
    </div>
  </div>

  <label>
    Client Deposit Rate (target)
    <span class="help" title="2.33% requires Avg ≥ £20k, 3.33% requires Avg ≥ £40k.">ⓘ</span>
  </label>
  <select id="targetRate">
    <option value="0.0233">2.33%</option>
    <option value="0.0333">3.33%</option>
  </select>

  <button onclick="calculate()">Calculate</button>
  <button class="secondary" onclick="exportCSV()">Export CSV</button>

  <div id="error"></div>

  <div class="out" id="results" style="display:none;">
    <div class="kv">
      <div class="k">Average Balance</div>
      <div class="v" id="avgBalance">–</div>
    </div>

    <div class="kv">
      <div class="k">Client Deposit Rate</div>
      <div class="v" id="clientRate">–</div>
    </div>

    <div class="kv">
      <div class="k">Cut Off Date</div>
      <div class="v" id="cutoffDate">–</div>
    </div>
  </div>
</div>

<script>
const daysByMonth = {
  Jan:31, Feb:28, Mar:31, Apr:30,
  May:31, Jun:30, Jul:31, Aug:31,
  Sep:30, Oct:31, Nov:30, Dec:31
};

function clientDepositRateFromAvg(avg) {
  if (avg < 20000) return 0;
  if (avg >= 40000) return 0.0333;
  return 0.0233;
}

function fmtGBP(x) {
  return x.toLocaleString(undefined,{style:"currency",currency:"GBP"});
}
function fmtPct(x) {
  return (x*100).toFixed(2) + "%";
}

function getThreshold(targetRate) {
  return targetRate >= 0.0333 ? 40000 : 20000;
}

function daysRequired(opening, closing, days, threshold) {
  if (opening === closing) return opening >= threshold ? 0 : Infinity;
  return ((threshold - opening) * days) / (closing - opening);
}

function calculate() {
  const opening = Number(openingEl.value);
  const closing = Number(closingEl.value);
  const month = monthEl.value;
  const year = Number(yearEl.value);
  const targetRate = Number(targetRateEl.value);

  errorEl.textContent = "";
  resultsEl.style.display = "none";

  const days = daysByMonth[month];
  if (![opening, closing, year].every(Number.isFinite)) {
    errorEl.textContent = "Please enter valid numbers.";
    return;
  }

  const threshold = getThreshold(targetRate);
  let D = daysRequired(opening, closing, days, threshold);
  if (!Number.isFinite(D)) {
    errorEl.textContent = "Target cannot be achieved with these balances.";
    return;
  }

  D = Math.min(Math.max(D, 0), days);
  const avg = ((opening * (days - D)) + (D * closing)) / days;
  const rate = clientDepositRateFromAvg(avg);

  avgBalanceEl.textContent = fmtGBP(avg);
  clientRateEl.textContent = fmtPct(rate);
  cutoffDateEl.textContent = `1 ${month} ${year}`;

  resultsEl.style.display = "block";
  window.__last = { opening, closing, month, year, avg, rate };
}

function exportCSV() {
  if (!window.__last) return;
  const r = window.__last;
  const csv =
    "Opening,Closing,Month,Year,AverageBalance,ClientDepositRate,CutOffDate\n" +
    `${r.opening},${r.closing},${r.month},${r.year},${r.avg},${(r.rate*100).toFixed(2)}%,1 ${r.month} ${r.year}`;
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "avg-balance-calculator.csv";
  a.click();
}

// element refs
const openingEl = document.getElementById("opening");
const closingEl = document.getElementById("closing");
const monthEl = document.getElementById("month");
const yearEl = document.getElementById("year");
const targetRateEl = document.getElementById("targetRate");

const avgBalanceEl = document.getElementById("avgBalance");
const clientRateEl = document.getElementById("clientRate");
const cutoffDateEl = document.getElementById("cutoffDate");
const resultsEl = document.getElementById("results");
const errorEl = document.getElementById("error");
</script>
</body>
</html>
