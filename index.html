
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Client Deposit Rate Calculator</title>
  <style>
    body { font-family: Arial; background:#f4f6f8; padding:20px; }
    .card {
      background:#fff; padding:20px; max-width:560px; border-radius:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    label { display:block; margin-top:12px; font-weight:700; }
    input, select {
      width:100%; padding:10px; margin-top:6px;
      border:1px solid #d6dbe1; border-radius:10px;
    }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    button {
      margin-top:14px; width:100%; padding:12px;
      border:0; border-radius:10px; background:#0078d4; color:#fff;
      font-weight:800; cursor:pointer;
    }
    button.secondary { background:#374151; }
    .out {
      margin-top:14px; padding:14px; background:#f8fafc;
      border:1px solid #e5e7eb; border-radius:12px;
    }
    .out p { margin:8px 0; }
    .muted { color:#6b7280; font-size: 13px; }
    #error { margin-top:10px; color:#b91c1c; font-weight:700; }
    .divider { margin-top:14px; border-top:1px solid #e5e7eb; padding-top:14px; }
  </style>
</head>

<body>
  <div class="card">
    <h3>Client Deposit Rate Calculator</h3>
    <div class="muted">
      Tooltips are available — hover over labels to see what each field means.
    </div>

    <div class="row">
      <div>
        <label title="Balance at the start of the month.">Opening Balance (£)</label>
        <input id="A" type="number" step="0.01" value="0">
      </div>
      <div>
        <label title="Balance after your deposit (the balance you will hold after the cut-off date).">Closing Balance (£)</label>
        <input id="B" type="number" step="0.01" value="400000">
      </div>
    </div>

    <div class="row">
      <div>
        <label title="Month used to determine days in month (hidden but used in calculations).">Month</label>
        <select id="C">
          <option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option>
          <option>May</option><option>Jun</option><option>Jul</option><option>Aug</option>
          <option>Sep</option><option>Oct</option><option>Nov</option><option>Dec</option>
        </select>
      </div>
      <div>
        <label title="Year used for the cut-off date display.">Year</label>
        <input id="Y" type="number" step="1">
      </div>
    </div>

    <label title="Select the rate you want to achieve. This triggers the GoalSeek-style calculation.">
      Client Deposit Rate (target)
    </label>
    <select id="TargetRate">
      <option value="0.0233">2.33%</option>
      <option value="0.0333" selected>3.33%</option>
    </select>

    <!-- Hidden fields (still used internally) -->
    <input id="DaysRequiredHidden" type="hidden">
    <input id="DaysInMonthHidden" type="hidden">

    <button onclick="calculate()">Calculate</button>
    <button class="secondary" onclick="exportCSV()">Export CSV (Excel)</button>

    <div id="error"></div>

    <div class="out">
      <p><b>Average Balance:</b> <span id="avg">–</span></p>
      <p>
        <b>Client Deposit Rate (based on Average Balance):</b>
        <span id="rate">–</span>
      </p>
      <p>
        <b>Cut Off Date:</b>
        <span id="cutoff">–</span>
      </p>

      <div class="divider">
        <p><b>Minimum Closing Balance & Cut Off Date (deposit today):</b></p>
        <p class="muted">
          This assumes you deposit <b>today</b> and hold that closing balance until month-end.
          (If “today” is outside the selected month, this will show N/A.)
        </p>
        <p><b>Minimum Closing Balance:</b> <span id="minClose">–</span></p>
        <p><b>Cut Off Date:</b> <span id="minCutoff">–</span></p>
      </div>
    </div>
  </div>

<script>
/** Field list: Month -> Days */
const daysByMonth = {
  Jan: 31, Feb: 28, Mar: 31, Apr: 30,
  May: 31, Jun: 30, Jul: 31, Aug: 31,
  Sep: 30, Oct: 31, Nov: 30, Dec: 31
};

/**
 * Rate tiers (from your Field list logic):
 * < 20k => 0%
 * 20k to < 40k => 2.33%
 * >= 40k => 3.33%
 */
function rateFromAvg(avg) {
  if (avg < 20000) return 0;
  if (avg >= 40000) return 0.0333;
  return 0.0233;
}

function formatMoney(x) {
  if (!Number.isFinite(x)) return "–";
  return x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatPercent(dec) {
  if (!Number.isFinite(dec)) return "–";
  return (dec * 100).toFixed(2) + "%";
}

function monthIndex(mon) {
  return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(mon);
}

function daysInMonth(mon) {
  return daysByMonth[mon] ?? NaN;
}

/**
 * GoalSeek equivalent:
 * Avg = A + D*(B-A)/days
 * Solve D for AvgTarget:
 * D = (AvgTarget - A) * days / (B - A)
 *
 * Matches VBA:
 * Range("E4").GoalSeek Goal:=40000, ChangingCell:=Range("D4")
 * Range("E4").GoalSeek Goal:=20000, ChangingCell:=Range("D4")
 */
function solveDaysRequired(A, B, days, avgTarget) {
  // If B == A, average is always A, cannot change with D.
  if (B === A) {
    return (avgTarget <= A) ? -1 : NaN; // -1 => meets minimum, NaN => impossible
  }
  return ((avgTarget - A) * days) / (B - A);
}

/**
 * Cut Off Date (based on your sheet logic):
 * IF(DaysRequired < 0, "Meets minimum", DaysInMonth - ROUNDUP(DaysRequired,0))
 */
function cutOffDayNumber(days, daysRequired) {
  if (!Number.isFinite(daysRequired)) return NaN;
  if (daysRequired < 0) return null; // Meets minimum
  const roundedUp = Math.ceil(daysRequired);
  return days - roundedUp;
}

function makeDateString(dayNum, mon, year) {
  if (!Number.isFinite(dayNum)) return "–";
  if (dayNum === null) return "Meets minimum";
  if (dayNum <= 0) return "Meets minimum";
  // Example: "28 Jul 2025"
  return `${dayNum} ${mon} ${year}`;
}

// Elements
const AEl = document.getElementById("A");
const BEl = document.getElementById("B");
const CEl = document.getElementById("C");
const YEl = document.getElementById("Y");
const TargetRateEl = document.getElementById("TargetRate");

const DaysReqHidden = document.getElementById("DaysRequiredHidden");
const DaysHidden = document.getElementById("DaysInMonthHidden");

const errEl = document.getElementById("error");
const avgEl = document.getElementById("avg");
const rateEl = document.getElementById("rate");
const cutoffEl = document.getElementById("cutoff");

const minCloseEl = document.getElementById("minClose");
const minCutoffEl = document.getElementById("minCutoff");

let last = null;

// Default year to current year (user asked to update year)
(function initYear() {
  const now = new Date();
  YEl.value = now.getFullYear();
})();

function calculate() {
  errEl.textContent = "";
  avgEl.textContent = "–";
  rateEl.textContent = "–";
  cutoffEl.textContent = "–";
  minCloseEl.textContent = "–";
  minCutoffEl.textContent = "–";
  last = null;

  const A = Number(AEl.value);
  const B = Number(BEl.value);
  const mon = CEl.value;
  const year = Number(YEl.value);
  const days = daysInMonth(mon);
  const targetRate = Number(TargetRateEl.value);

  if (![A, B, year].every(n => Number.isFinite(n))) {
    errEl.textContent = "Please enter valid numbers for Opening Balance, Closing Balance, and Year.";
    return;
  }
  if (!Number.isFinite(days)) {
    errEl.textContent = "Month not found in field list.";
    return;
  }

  // Determine target Avg Balance from selected target rate:
  // 2.33% => target 20,000
  // 3.33% => target 40,000
  const avgTarget = (targetRate === 0.0233) ? 20000 : 40000;

  // GoalSeek equivalent: solve for Days Required
  const daysRequired = solveDaysRequired(A, B, days, avgTarget);

  // Store hidden (still used)
  DaysReqHidden.value = Number.isFinite(daysRequired) ? daysRequired : "";
  DaysHidden.value = days;

  // Compute Avg Balance using Excel formula:
  // Avg = ((A*(days-D)) + (D*B)) / days
  // Use the solved daysRequired (dynamic)
  if (!Number.isFinite(daysRequired)) {
    errEl.textContent = "Cannot reach the target with these balances (check Opening vs Closing).";
    return;
  }

  const avgBalance = ((A * (days - daysRequired)) + (daysRequired * B)) / days;

  // Client Deposit Rate (based on Avg Balance tiers)
  let clientRate = rateFromAvg(avgBalance);

  // Your rule:
  // If average balance is < 20000 for 2.33 target, client deposit rate should be 0%
  // (This is already true via tier logic, but we keep it explicit.)
  if (targetRate === 0.0233 && avgBalance < 20000) {
    clientRate = 0;
  }

  // Cut off date includes month + year
  const dayNum = cutOffDayNumber(days, daysRequired);
  const cutOffText = makeDateString(dayNum, mon, year);

  // Outputs
  avgEl.textContent = "£" + formatMoney(avgBalance);
  rateEl.textContent = formatPercent(clientRate);
  cutoffEl.textContent = cutOffText;

  // Extra bottom calculation:
  // Minimum closing balance if you deposit TODAY and hold until month end.
  // If today is outside selected month/year => N/A
  const today = new Date();
  const selMonthIdx = monthIndex(mon);

  const isSameMonthYear =
    (today.getFullYear() === year) && (today.getMonth() === selMonthIdx);

  if (!isSameMonthYear) {
    minCloseEl.textContent = "N/A";
    minCutoffEl.textContent = "N/A";
  } else {
    const todayDay = today.getDate();
    const remainingIncludingToday = (days - todayDay + 1);

    if (remainingIncludingToday <= 0) {
      minCloseEl.textContent = "N/A";
      minCutoffEl.textContent = "N/A";
    } else {
      // Solve B_needed with D = remainingIncludingToday:
      // AvgTarget = A + D*(B-A)/days  ->  B = A + (AvgTarget - A)*days / D
      const minClosing = A + ((avgTarget - A) * days) / remainingIncludingToday;
      minCloseEl.textContent = "£" + formatMoney(minClosing);
      minCutoffEl.textContent = makeDateString(todayDay, mon, year);
    }
  }

  last = {
    opening: A, closing: B, month: mon, year, daysInMonth: days,
    targetRate, avgTarget, daysRequired, avgBalance, clientRate, cutOffText
  };
}

function exportCSV() {
  errEl.textContent = "";
  if (!last) {
    errEl.textContent = "Calculate first, then export.";
    return;
  }

  const header = [
    "OpeningBalance","ClosingBalance","Month","Year","DaysInMonth",
    "TargetRate","TargetAvgBalance","DaysRequired",
    "AverageBalance","ClientDepositRate","CutOffDate"
  ].join(",");

  const row = [
    last.opening,
    last.closing,
    last.month,
    last.year,
    last.daysInMonth,
    (last.targetRate * 100).toFixed(2) + "%",
    last.avgTarget,
    last.daysRequired,
    last.avgBalance,
    (last.clientRate * 100).toFixed(2) + "%",
    `"${last.cutOffText}"`
  ].join(",");

  const csv = header + "\n" + row;

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "client-deposit-rate-calculator.csv";
  link.click();
}
</script>
</body>
</html>
