<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Average Balance Calculator</title>
  <style>
    body { font-family: Arial; background:#f4f6f8; padding:20px; }
    .card { background:#fff; padding:20px; max-width:560px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.06); }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select { width:100%; padding:8px; margin-top:6px; border:1px solid #d6dbe1; border-radius:8px; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    button { margin-top:14px; width:100%; padding:10px; border:0; border-radius:8px; background:#0078d4; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#374151; }
    .out { margin-top:14px; padding:12px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; }
    .out p { margin:6px 0; }
    #error { margin-top:10px; color:#b91c1c; font-weight:600; }
    small { color:#6b7280; display:block; margin-top:6px; }
  </style>
</head>

<body>
  <div class="card">
    <h3>Average Balance Calculator</h3>
    <small>
      Days Required is calculated automatically to achieve the selected rate.
    </small>

    <div class="row">
      <div>
        <label>Opening Balance (£)</label>
        <input id="A" type="number" step="0.01" value="0">
      </div>
      <div>
        <label>Closing Balance (£)</label>
        <input id="B" type="number" step="0.01" value="400000">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Month</label>
        <select id="C">
          <option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option>
          <option>May</option><option>Jun</option><option selected>Jul</option><option>Aug</option>
          <option>Sep</option><option>Oct</option><option>Nov</option><option>Dec</option>
        </select>
      </div>
      <div>
        <label>Target Rate</label>
        <select id="target">
          <option value="40000" selected>3.33%</option>
          <option value="20000">2.33%</option>
        </select>
      </div>
    </div>

    <button onclick="calculate()">Calculate</button>
    <button class="secondary" onclick="exportCSV()">Export CSV</button>

    <div id="error"></div>

    <div class="out">
      <p><b>Days Required:</b> <span id="daysReq">–</span></p>
      <p><b>Average Balance:</b> <span id="avg">–</span></p>
      <p><b>Client Rate:</b> <span id="rate">–</span></p>
      <p><b>Cut Off Date:</b> <span id="cutoff">–</span></p>
      <p><b>Remaining Days:</b> <span id="remaining">–</span></p>
    </div>
  </div>

<script>
const daysByMonth = {
  Jan:31, Feb:28, Mar:31, Apr:30,
  May:31, Jun:30, Jul:31, Aug:31,
  Sep:30, Oct:31, Nov:30, Dec:31
};

const rateTier = {
  lt20000: 0,
  between: 0.0233,
  gte40000: 0.0333
};

const AEl = document.getElementById("A");
const BEl = document.getElementById("B");
const CEl = document.getElementById("C");
const targetEl = document.getElementById("target");

const errEl = document.getElementById("error");
const daysReqEl = document.getElementById("daysReq");
const avgEl = document.getElementById("avg");
const rateEl = document.getElementById("rate");
const cutoffEl = document.getElementById("cutoff");
const remainingEl = document.getElementById("remaining");

function formatMoney(x) {
  return x.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function formatPct(x) {
  return (x * 100).toFixed(2) + "%";
}

function getClientRate(avg) {
  if (avg < 20000) return rateTier.lt20000;
  if (avg >= 40000) return rateTier.gte40000;
  return rateTier.between;
}

function solveDaysRequired(A,B,days,target) {
  if (A === B) {
    if (A >= target) return {status:"MEETS"};
    return {status:"IMPOSSIBLE"};
  }
  const D = (target - A) * days / (B - A);
  if (D < 0) return {status:"MEETS"};
  return {status:"OK", value:D};
}

function avgBalance(A,B,days,D) {
  return ((A * (days - D)) + (D * B)) / days;
}

function calculate() {
  errEl.textContent = "";
  const A = Number(AEl.value);
  const B = Number(BEl.value);
  const month = CEl.value;
  const days = daysByMonth[month];
  const target = Number(targetEl.value);

  if (![A,B].every(Number.isFinite)) {
    errEl.textContent = "Please enter valid balances.";
    return;
  }

  const solved = solveDaysRequired(A,B,days,target);

  if (solved.status === "IMPOSSIBLE") {
    daysReqEl.textContent = "Not achievable";
    avgEl.textContent = "–";
    rateEl.textContent = "–";
    cutoffEl.textContent = "–";
    remainingEl.textContent = "–";
    return;
  }

  const D = solved.status === "MEETS" ? 0 : solved.value;
  const avg = avgBalance(A,B,days,D);

  daysReqEl.textContent = solved.status === "MEETS" ? "Meets minimum" : D.toFixed(2);
  avgEl.textContent = formatMoney(avg);
  rateEl.textContent = formatPct(getClientRate(avg));

  const cut = days - Math.ceil(D);
  cutoffEl.textContent = solved.status === "MEETS" ? "Meets minimum" : `${cut} ${month}`;
  remainingEl.textContent = solved.status === "MEETS" ? days : cut;
}

function exportCSV() {
  const csv = "Opening,Closing,Month,DaysRequired,AverageBalance,ClientRate\n" +
    `${AEl.value},${BEl.value},${CEl.value},${daysReqEl.textContent},${avgEl.textContent},${rateEl.textContent}`;
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "avg-balance-calculator.csv";
  a.click();
}

calculate();
</script>
</body>
</html>
